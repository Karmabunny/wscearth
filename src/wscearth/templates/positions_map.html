<!doctype html>
<html>
  <head>
    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <script>
    window.wsc = (function() {
      let map;
      const markers = {};

      async function getPositions() {
        const res = await fetch('api/positions');

        if (!res.ok) {
          const message = `${res.status}: ` + await res.text();
          throw new Error(message);
        }

        const json = await res.json();
        return json;
      }

      function updateMarkers(items) {

        for (let item of items) {

          if (!item.shortname) {
            console.warn('missing shortname:', item);
            continue;
          }

          if (
            typeof item.latitude !== 'number'
            || typeof item.longitude !== 'number'
          ) {
            console.warn('invalid position:', item);
            continue
          }

          let marker = markers[item.shortname];

          // Update existing markers.
          if (marker) {
            marker.setPosition({
              lat: item.latitude,
              lng: item.longitude,
            });
            continue;
          }

          // It's a new marker.
          markers[item.shortname] = new google.maps.Marker({
            map: map,
            title: item.shortname,
            position: {
              lat: item.latitude,
              lng: item.longitude,
            }
          });
        }
      }

      async function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -25.0, lng: 133.0 },
          zoom: 4,
        });

        // Create an info window to share between markers.
        const infoWindow = new google.maps.InfoWindow();

        const data = await getPositions();

        // Initial map position based on the mean of all positions.
        map.setCenter(data.center);
        updateMarkers(data.items);

        // Add a click listener for each marker, and set up the info window.
        for (let marker of Object.values(markers)) {
          marker.addListener("click", () => {
            infoWindow.close();
            infoWindow.setContent(marker.getTitle());
            infoWindow.open(marker.getMap(), marker);
          })
        }

        // Loop it.
        setInterval(async () => {
          const data = await getPositions();
          updateMarkers(data.items);
        }, 5000);
      }

      window.initMap = initMap;

      return {
        map,
        markers,
        getPositions,
        updateMarkers,
      }
    })();
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MXGQHB1S3T"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-MXGQHB1S3T');
    </script>
  </head>

  <body>
    <div id="map"></div>

    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4cxmf6zr3SMovEYgZZe9eoEQCglqz3L8&callback=initMap&v=weekly"
      async
    ></script>
  </body>
</html>
